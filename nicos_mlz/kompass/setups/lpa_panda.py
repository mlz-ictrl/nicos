description = 'Kompass setup for longitudinal polarisation analysis mode'

group = 'optional'

excludes = ['lpa_kompass']

tango_base = 'tango://kompasshw.kompass.frm2.tum.de:10000/kompass/'

# kepco1 --> sf1_c
# kepco2 --> sf1_f
# kepco3 --> sf2_c
# kepco4 --> sf2_f
# kepco5 --> coil1
# kepco6 --> coil2
# kepco7 --> coil3

device_names = ['sf1_c', 'sf1_f', 'sf2_c', 'sf2_f', 'coil1', 'coil2', 'coil3']

devices = dict(
    coil1_field=device('nicos_mlz.kompass.devices.gf_lpa.VectorCoil',
                       description='Powersupply for horizontal field 1 at sample',
                       tangodevice=tango_base + 'kepco/current5',
                       abslimits=(-20, 20),
                       orientation=(0.53, 0.53, 0),  # mT - calibrated 30/04/2021 at KOMPASS
                       calibrationcurrent=10,  # A
                       ),
    coil2_field=device('nicos_mlz.kompass.devices.gf_lpa.VectorCoil',
                       description='Powersupply for horizontal field 2 at sample',
                       tangodevice=tango_base + 'kepco/current6',
                       abslimits=(-20, 20),
                       orientation=(0.53, -0.53, 0),  # mT - calibrated 30/04/2021 at KOMPASS
                       calibrationcurrent=10,  # A
                       ),
    coil3_field=device('nicos_mlz.kompass.devices.gf_lpa.VectorCoil',
                       description='Powersupply for vertical field at sample',
                       tangodevice=tango_base + 'kepco/current7',
                       abslimits=(-20, 20),
                       orientation=(0, 0, 2.33),  # mT - calibrated 30/04/2021 at KOMPASS
                       calibrationcurrent=2,  # A  only 2A at KOMPASS, at PANDA was 10 A
                       ),
    gf=device('nicos_mlz.kompass.devices.gf_lpa.GF_Panda',
              description='Vector field at sample location',
              alpha='alphastorage',
              coils=['coil1_field', 'coil2_field', 'coil3_field'],  # the names of the fields generated by coils
              alphaoffset=0,
              field=0.8,  # mT, TODO to be determined by measuring
              mapping={'off': None,
                       'x': (1., 0., 0.),
                       '-x': (-1., 0., 0.),
                       'y': (0., 1., 0.),
                       '-y': (0., -1., 0.),
                       'z': (0., 0., 1.),
                       '-z': (0., 0., -1.),
                       'up': (0., 0., 1.),
                       'down': (0., 0., -1.),
                       '0': (0., 0., 0.)},
              ),
    sf1=device('nicos.devices.polarized.KFlipper',
               description='Spin Flipper 1 (before sample)',
               flip='sf1_f',  # 'kepco2_current',
               corr='sf1_c',  # 'kepco1_current',
               kvalue='ki',
               flipcurrent=[-0.18037, -0.43804],  # TODO measure the new values
               compcurrent=2.35,  # TODO measure the new values
               ),
    sf2=device('nicos.devices.polarized.KFlipper',
               description='Spin Flipper 2 (after sample)',
               flip='sf2_f',  # 'kepco4_current',
               corr='sf2_c',  # 'kepco3_current',
               kvalue='kf',  # for ellastic LPA can be changed back into "ki"
               # for kf=1.55+befilter
               flipcurrent=[0.083, 0.38],  # TODO measure the new values
               compcurrent=1.45,  # TODO measure the new values
               # for kf=1.94 +/-pg
               # flipcurrent = [0.765, 0],
               # compcurrent = 2.4474,
               ),
)

for i, devname in enumerate(device_names):
    devices[f'{devname}_current'] = device('nicos.devices.entangle.PowerSupply',
                                           description=f'{devname}, kepco power supply {i + 1} current',
                                           tangodevice=tango_base + f'kepco/current{i + 1}',
                                           fmtstr='%.3f',
                                           )
    devices[f'{devname}_voltage'] = device('nicos.devices.entangle.Sensor',
                                           description=f'{devname}, kepco power supply {i + 1} voltage',
                                           tangodevice=tango_base + f'kepco/voltage{i + 1}',
                                           fmtstr='%.3f',
                                           )
